/*
 * File: app/view/productSettingsForm.js
 *
 * This file was generated by Sencha Architect version 2.2.3.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.2.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.2.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Rubedo.view.productSettingsForm', {
    extend: 'Ext.panel.Panel',
    alias: 'widget.productSettingsForm',

    id: 'productSettingsForm',
    layout: {
        align: 'stretch',
        type: 'vbox'
    },
    title: 'Product settings',

    initComponent: function() {
        var me = this;

        Ext.applyIf(me, {
            items: [
                {
                    xtype: 'form',
                    bodyPadding: 10,
                    title: '',
                    items: [
                        {
                            xtype: 'textfield',
                            anchor: '100%',
                            fieldLabel: 'SKU',
                            labelWidth: 140,
                            name: 'sku',
                            allowBlank: false,
                            allowOnlyWhitespace: false
                        },
                        {
                            xtype: 'numberfield',
                            anchor: '100%',
                            id: 'basePriceField',
                            fieldLabel: 'Base price',
                            labelWidth: 140,
                            name: 'basePrice',
                            allowBlank: false,
                            minValue: 0
                        },
                        {
                            xtype: 'numberfield',
                            anchor: '100%',
                            fieldLabel: 'Preparation delay (days)',
                            labelWidth: 140,
                            name: 'preparationDelay',
                            allowBlank: false,
                            minValue: 0
                        },
                        {
                            xtype: 'fieldset',
                            id: 'stockManagentForProductFieldset',
                            title: 'Stock management',
                            items: [
                                {
                                    xtype: 'checkboxfield',
                                    anchor: '100%',
                                    fieldLabel: 'Can order out of stock',
                                    labelWidth: 140,
                                    name: 'canOrderNotInStock',
                                    boxLabel: '',
                                    inputValue: 'true',
                                    uncheckedValue: 'false'
                                },
                                {
                                    xtype: 'numberfield',
                                    anchor: '100%',
                                    fieldLabel: 'Out of stock limit',
                                    labelWidth: 140,
                                    name: 'outOfStockLimit',
                                    allowBlank: false,
                                    minValue: 0
                                },
                                {
                                    xtype: 'numberfield',
                                    anchor: '100%',
                                    fieldLabel: 'Notify for stock below',
                                    labelWidth: 140,
                                    name: 'notifyForQuantityBelow',
                                    allowBlank: false,
                                    minValue: 0
                                },
                                {
                                    xtype: 'numberfield',
                                    anchor: '100%',
                                    fieldLabel: 'Resupply delay (days)',
                                    labelWidth: 140,
                                    name: 'resupplyDelay',
                                    allowBlank: false,
                                    minValue: 0
                                }
                            ]
                        }
                    ]
                },
                {
                    xtype: 'gridpanel',
                    flex: 1,
                    id: 'productVariationsGrid',
                    title: 'Variations',
                    columns: [
                        {
                            xtype: 'gridcolumn',
                            dataIndex: 'string',
                            text: 'String'
                        },
                        {
                            xtype: 'numbercolumn',
                            dataIndex: 'number',
                            text: 'Number'
                        },
                        {
                            xtype: 'datecolumn',
                            dataIndex: 'date',
                            text: 'Date'
                        },
                        {
                            xtype: 'booleancolumn',
                            dataIndex: 'bool',
                            text: 'Boolean'
                        }
                    ],
                    viewConfig: {
                        plugins: [
                            Ext.create('Ext.grid.plugin.DragDrop', {

                            })
                        ]
                    },
                    dockedItems: [
                        {
                            xtype: 'toolbar',
                            dock: 'top',
                            items: [
                                {
                                    xtype: 'tbfill'
                                },
                                {
                                    xtype: 'button',
                                    iconCls: 'add',
                                    text: 'Add',
                                    listeners: {
                                        click: {
                                            fn: me.onButtonClick,
                                            scope: me
                                        }
                                    }
                                },
                                {
                                    xtype: 'button',
                                    disabled: true,
                                    id: 'variationRemoverBtn',
                                    iconCls: 'close',
                                    text: 'Remove',
                                    listeners: {
                                        click: {
                                            fn: me.onVariationRemoverBtnClick,
                                            scope: me
                                        }
                                    }
                                }
                            ]
                        }
                    ],
                    listeners: {
                        selectionchange: {
                            fn: me.onProductVariationsGridSelectionChange,
                            scope: me
                        }
                    },
                    plugins: [
                        Ext.create('Ext.grid.plugin.CellEditing', {
                            clicksToEdit: 1
                        })
                    ]
                }
            ]
        });

        me.callParent(arguments);
    },

    onButtonClick: function(button, e, eOpts) {
        var form=button.up().up().up().getComponent(0).getForm();
        if (form.isValid()){
            Ext.Ajax.request({
                url: 'xhr-get-mongo-id',
                params: { },
                success: function(response){
                    var servedId = Ext.JSON.decode(response.responseText).mongoID;
                    button.up().up().getStore().add({price:form.getValues().basePrice,sku:form.getValues().sku,stock:0, id:servedId});
                },
                failure: function(){
                    Ext.Msg.alert(Rubedo.RubedoAutomatedElementsLoc.errorTitle, "Failed to retrieve ID");

                }
            });
        } else {
            Ext.Msg.alert("Error","SKU and Base price are required in order to create variations");
        }

    },

    onVariationRemoverBtnClick: function(button, e, eOpts) {
        button.up().up().getStore().remove(button.up().up().getSelectionModel().getLastSelected());
    },

    onProductVariationsGridSelectionChange: function(model, selected, eOpts) {
        if (Ext.isEmpty(selected)){
            Ext.getCmp("variationRemoverBtn").disable();
        } else {
            Ext.getCmp("variationRemoverBtn").enable();
        }
    },

    isValid: function() {
        if (!Ext.getCmp("productSettingsForm").getComponent(0).getForm().isValid()){
            Ext.Msg.alert(Rubedo.RubedoAutomatedElementsLoc.errorTitle,"Invalid product settings");
            return false;
        }
        if (Ext.isEmpty(Ext.getCmp("productSettingsForm").getComponent(1).getStore().getRange())){
            Ext.Msg.alert(Rubedo.RubedoAutomatedElementsLoc.errorTitle,"Product must have at least one variation");
            return false;
        }
        var dataOk=true;
        Ext.Array.forEach(Ext.Array.pluck(Ext.getCmp("productSettingsForm").getComponent(1).getStore().getRange(),"data"),function(variation){
            Ext.Object.each(variation, function(key, value, myself) {
                if (Ext.isEmpty(value)){
                    dataOk=false;
                }
            });
        });
        if (!dataOk){
            Ext.Msg.alert(Rubedo.RubedoAutomatedElementsLoc.errorTitle,"Invalid variation settings. Each variation must have a valid value for each column");
        }
        return dataOk;
    }

});