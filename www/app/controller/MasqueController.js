/*
 * File: app/controller/MasqueController.js
 *
 * This file was generated by Sencha Architect version 2.2.2.
 * http://www.sencha.com/products/architect/
 *
 * This file requires use of the Ext JS 4.1.x library, under independent license.
 * License of Sencha Architect does not include license for Ext JS 4.1.x. For more
 * details see http://www.sencha.com/license or contact license@sencha.com.
 *
 * This file will be auto-generated each and everytime you save your project.
 *
 * Do NOT hand edit this file.
 */

Ext.define('Rubedo.controller.MasqueController', {
    extend: 'Ext.app.Controller',

    models: [
        'masquesDataModel'
    ],
    stores: [
        'VersionsDataJson',
        'MasquesDataJson'
    ],
    views: [
        'nouveauMasque',
        'ImportationMasques',
        'copierMasque',
        'UnBloc',
        'ConfigSpecBloc',
        'ajoutBlocFenetre',
        'DelConfirmZ'
    ],

    refs: [
        {
            ref: 'MasqueEdition',
            selector: '#masqueEdition'
        }
    ],

    deleteMask: function(button, e, eOpts) {
        var cible = Ext.getCmp('masquesGrid').getSelectionModel().getSelection()[0];
        if (Ext.isDefined(cible)) {
            Ext.Ajax.request({
                url: 'masks/is-used',
                params: {
                    id: cible.get("id")
                },
                success: function(response){
                    var maskIsUsed=Ext.JSON.decode(response.responseText).used;
                    if (maskIsUsed){
                        Ext.Msg.alert(Rubedo.RubedoAutomatedElementsLoc.errorTitle, Rubedo.RubedoAutomatedElementsLoc.maskIsUsedText);
                    } else {
                        var fenetre = Ext.widget('delConfirmZ');
                        fenetre.show();
                        Ext.getCmp('delConfirmZOui').on('click', function() { 
                            Ext.getCmp('masquesGrid').getStore().remove(cible);
                            Ext.getCmp('masqueEdition').removeAll();
                            Ext.getCmp('masqueEdition').pageProperties={ };
                            Ext.getCmp("newRow").disable();
                            Ext.getCmp("newCol").disable();
                            Ext.getCmp("newBloc").disable();
                            Ext.getCmp("deleteElement").disable();
                            Ext.getCmp('elementEditControl').setTitle(Rubedo.RubedoAutomatedElementsLoc.selectAnElementText);
                            Ext.getCmp('elementEditControl').removeAll();
                            Ext.getCmp('elementEditControl').setIconCls();
                            Ext.getCmp('elementIdField').setValue(null);
                            Ext.getCmp('delConfirmZ').close();
                            Ext.Array.forEach(Ext.getCmp("adminFMDP").getComponent("contextBar").query("buttongroup"), function(btn){btn.disable();});
                            Ext.getCmp("boutonSupprimerMasque").disable();
                            Ext.getCmp("adminFMDP").getDockedComponent('barreMeta').getComponent('boiteBarreMeta').hide();
                        }); 
                    }
                }
            });
        }
    },

    masquesDisplay: function(rowmodel, record, index, eOpts) {
        var dataview = Ext.getCmp("masquesGrid");
        var boiteMeta = dataview.findParentByType('window').getDockedComponent('barreMeta').getComponent('boiteBarreMeta');
        var valeurs= Ext.clone(record.data);
        valeurs.creation= Ext.Date.format(valeurs.createTime, 'd-m-Y');
        valeurs.derniereModification= Ext.Date.format(valeurs.lastUpdateTime, 'd-m-Y');
        boiteMeta.update(valeurs);
        boiteMeta.show();

        var filArianne = dataview.findParentByType('window').getDockedComponent('filArianne');
        var typeFil = filArianne.getComponent('type');
        if (Ext.isDefined(typeFil)) {typeFil.setText(record.data.text);}
        else { typeFil= Ext.widget('button',{iconCls: "masque-icon", text:record.data.text, itemId:'type'});
        filArianne.add(typeFil);
    }
    var masque = record.data;
    var prevSelected = Ext.getCmp(Ext.getCmp('elementIdField').getValue());
    if (!Ext.isEmpty(prevSelected)) {
        prevSelected.removeBodyCls('selectedelement');
    }
    this.getMasqueEdition().pageProperties=Ext.clone(record.get("pageProperties"));
    Ext.suspendLayouts();
    this.getMasqueEdition().removeAll();
    this.masqueRestit(Ext.clone(masque.rows),1,this.getMasqueEdition()); 
    this.restoreBlocks(Ext.clone(masque.blocks));
    Ext.resumeLayouts();

    Ext.getCmp("newRow").disable();
    Ext.getCmp("newCol").disable();
    Ext.getCmp("newBloc").disable();
    Ext.getCmp("importElement").disable();
    Ext.getCmp("exportElement").disable();
    Ext.getCmp("deleteElement").disable();
    Ext.getCmp("moveElementUp").disable();
    Ext.getCmp("moveElementDown").disable();
    Ext.getCmp('elementEditControl').setTitle(Rubedo.RubedoAutomatedElementsLoc.selectAnElementText);
    Ext.getCmp('elementEditControl').removeAll();
    Ext.getCmp('elementEditControl').setIconCls();
    Ext.getCmp('elementIdField').setValue(null);
    Ext.getCmp("boutonSupprimerMasque").enable();
    Ext.getCmp("AdminfMasquesEnregistrer").enable();
    Ext.Array.forEach(Ext.getCmp("adminFMDP").getComponent("contextBar").query("buttongroup"), function(btn){btn.enable();});
    Ext.getCmp("mainColumnIdField").setValue(Ext.clone(record.get("mainColumnId")));
    if (record.get("readOnly")){
        Ext.getCmp("masksEditionTopBarBox").disable();
        Ext.getCmp("boutonSupprimerMasque").disable();
        Ext.getCmp("AdminfMasquesEnregistrer").disable();
    }
    },

    reusablesGridSelect: function(rowmodel, record, index, eOpts) {
        Ext.getCmp("reusableelementDescription").update(record.data);
        Ext.getCmp("resusableElementsDeleteBtn").enable();
        var go =true;

        var target=Ext.getCmp("ReusableElementPicker").insTar;

        if (record.get("mType")==target.mType) {go=false;}

        else if ((target.mType=="row")&&(Ext.getCmp(target.id).getComponent("eol").flex===0)) {go=false;}

        else if ((record.get("mType")=="row")&&(target.mType=="bloc")) {go=false;}
        else if ((record.get("mType")!="row")&&(target.id=="masqueEdition")) {go=false;}
        else if ((record.get("mType")!="bloc")&&(target.level==4)) {go=false;}
        else if((record.get("mType")=="bloc")&&(!Ext.isEmpty(target.mCode.rows))) {go=false;}
        else if((target.id!="masqueEdition")&&(record.get("mType")=="row")&&(!Ext.isEmpty(target.mCode.bloc))) {go=false;}



        if (go) {Ext.getCmp("REAddButton").enable(); } else {Ext.getCmp("REAddButton").disable(); }
    },

    onTreepanelItemClick: function(dataview, record, item, index, e, eOpts) {
        var cible = Ext.getCmp('arborescenceSites').getSelectionModel().getSelection()[0];
        this.getMasqueEdition().removeAll();
        this.getMasqueEdition().setWidth(cible.data.largeur);
        this.masqueRestit(cible.raw.zones);
    },

    copyMaskWindow: function(button, e, eOpts) {
        var cible = Ext.getCmp('masquesGrid').getSelectionModel().getSelection()[0];
        if (Ext.isDefined(cible)) {
            var fenetre = Ext.widget('copierMasque');
            fenetre.showAt(screen.width/2-150, 100);
            Ext.getCmp('copierMasqueTitre').setValue(cible.data.text+" - Copie du "+Ext.Date.format(new Date(), 'j F, Y, G:i'));
        }
    },

    newMaskWindow: function(button, e, eOpts) {
        var fenetre = Ext.widget('nouveauMasque');
        fenetre.show();
    },

    createMask: function(button, e, eOpts) {
        if ((Ext.getCmp('nouveauMasqueTitre').isValid())&&(Ext.getCmp('nouveauMasqueSite').isValid())) {

            var nTitre = Ext.getCmp('nouveauMasqueTitre').getValue();
            var nSite = Ext.getCmp('nouveauMasqueSite').getValue();
            var nouvMasque = Ext.create('model.masquesDataModel', {
                text: nTitre,
                site: nSite,
                rows: [ ],
                blocks:[ ]
            });
            this.getMasquesDataJsonStore().add(nouvMasque);
            this.getMasquesDataJsonStore().addListener("datachanged",function(){Ext.getCmp('masquesGridView').getSelectionModel().select(nouvMasque);},this,{single:true});

            Ext.getCmp('nouveauMasqueFenetre').close();
            this.masquesDisplay(Ext.getCmp('masquesGridView'),nouvMasque);

        }
    },

    maskSave: function(button, e, eOpts) {
        var me =this;
        var cible = Ext.getCmp('masquesGrid').getSelectionModel().getSelection()[0];
        if (Ext.isDefined(cible)) {
            Ext.Ajax.request({
                url: 'masks/is-used',
                params: {
                    id: cible.get("id")
                },
                success: function(response){
                    var maskIsUsed=Ext.JSON.decode(response.responseText).used;
                    if (maskIsUsed){
                        var chooser = Ext.widget("maskSaveChoiceBox");
                        chooser.getComponent(0).on("click", function(){
                            cible.beginEdit();
                            cible.set("rows",me.saveRows(me.getMasqueEdition()));
                            cible.set("blocks",me.saveBlocks(me.getMasqueEdition()));
                            cible.set("pageProperties",Ext.clone(Ext.getCmp('masqueEdition').pageProperties));
                            cible.set("mainColumnId",Ext.clone(Ext.getCmp("mainColumnIdField").getValue()));
                            cible.endEdit();  
                            chooser.close();
                        });
                        chooser.getComponent(1).on("click", function(){
                            var nouvMasque = Ext.create('model.masquesDataModel', {
                                text: "Nouveau masque",
                                site: cible.get("site")

                            });
                            nouvMasque.set("rows",me.saveRows(me.getMasqueEdition()));
                            nouvMasque.set("blocks",me.saveBlocks(me.getMasqueEdition()));
                            nouvMasque.set("pageProperties",Ext.clone(Ext.getCmp('masqueEdition').pageProperties));
                            nouvMasque.set("mainColumnId",Ext.clone(Ext.getCmp("mainColumnIdField").getValue()));
                            me.getMasquesDataJsonStore().add(nouvMasque);
                            me.getMasquesDataJsonStore().addListener("datachanged",function(){Ext.getCmp('masquesGridView').getSelectionModel().select(nouvMasque);},this,{single:true});  
                            chooser.close();
                        });
                        chooser.show();
                    } else {
                        cible.beginEdit();
                        cible.set("rows",me.saveRows(me.getMasqueEdition()));
                        cible.set("blocks",me.saveBlocks(me.getMasqueEdition()));
                        cible.set("pageProperties",Ext.clone(Ext.getCmp('masqueEdition').pageProperties));
                        cible.set("mainColumnId",Ext.clone(Ext.getCmp("mainColumnIdField").getValue()));
                        cible.endEdit();   
                    }
                }
            });


        }

    },

    copyMask: function(button, e, eOpts) {
        if ((Ext.getCmp('copierMasqueTitre').isValid())&&(Ext.getCmp('copierMasqueSite').isValid())) {
            var cible = Ext.getCmp('masquesGrid').getSelectionModel().getSelection()[0];
            var nTitre = Ext.getCmp('copierMasqueTitre').getValue();
            var nSite = Ext.getCmp('copierMasqueSite').getValue();
            var nRows = Ext.clone(cible.data.rows);
            var nBlocks=Ext.clone(cible.data.blocks);
            var nProperties=Ext.clone(cible.data.pageProperties);
            var nouvMasque = Ext.create('model.masquesDataModel', {
                text: nTitre,
                site: nSite,
                rows: nRows,
                blocks:nBlocks,
                pageProperties:nProperties

            });
            this.getMasquesDataJsonStore().add(nouvMasque);
            this.getMasquesDataJsonStore().addListener("datachanged",function(){Ext.getCmp('masquesGridView').getSelectionModel().select(nouvMasque);},this,{single:true});

            Ext.getCmp('copieMasqueFenetre').close();    
        }
    },

    importMaskWindow: function(button, e, eOpts) {
        var fenetre = Ext.widget('importationMasques');
        fenetre.showAt(screen.width/2-150, 100);

    },

    selectionEvents: function(component, eOpts) {
        var me=this;

        if (!component.isXType("unBloc")){
            component.addBodyCls('contrastBorder');
            if (component.mType=="col"){
                component.addBodyCls('contrastRow');
            }
            component.getEl().on("mouseover", function(e){
                component.setBorder(4);
                e.stopEvent();
            });
            component.getEl().on("mouseout", function(e){
                component.setBorder(2);
                e.stopEvent();
            });
            component.getEl().on("click", function(e){
                var prevSelected = Ext.getCmp(Ext.getCmp('elementIdField').getValue());
                if (!Ext.isEmpty(prevSelected)) {
                    if (prevSelected.isXType("unBloc")) {prevSelected.setIconCls();} else {
                prevSelected.removeBodyCls('selectedelement');}
            }
            component.addBodyCls('selectedelement');
            this.frame(MyPrefData.themeColor);
            Ext.getCmp('elementIdField').setValue(component.id);
            Ext.getCmp('deleteElement').enable();
            Ext.getCmp("importElement").enable();
            Ext.getCmp("exportElement").enable();
            var propEdit=Ext.getCmp('elementEditControl');
            if (component.mType=="col"){
                propEdit.setTitle(Rubedo.RubedoAutomatedElementsLoc.columnText);
            } else {
                propEdit.setTitle(Rubedo.RubedoAutomatedElementsLoc.lignText);
            }
            propEdit.setIconCls('editZone');


            propEdit.removeAll();
            var configSpec = Ext.widget('ConfigSpecBloc');


            configSpec.getComponent(0).add(Ext.widget('textfield',{
                itemId:"eTitleField",
                fieldLabel:Rubedo.RubedoAutomatedElementsLoc.titleText,
                onChange:function(){
                    if (this.isValid()){
                        component.eTitle=this.getValue();
                    }
                },
                labelWidth:60,
                allowBlank:false,
                anchor:"100%",
                margin:"10 0 10 0",
                value:component.eTitle
            }));
            configSpec.getComponent(0).add(Ext.widget('checkbox',{
                itemId:"eTitleShowField",
                fieldLabel:Rubedo.RubedoAutomatedElementsLoc.displayTitleText,
                onChange:function(){

                    component.displayTitle=this.getValue();

                },
                labelWidth:60,
                inputValue:true,
                anchor:"100%",
                margin:"10 0 10 0",
                checked:component.displayTitle
            }));

            configSpec.getComponent(0).add(Ext.widget('checkboxgroup',{
                fieldLabel:Rubedo.RubedoAutomatedElementsLoc.visibilityText,
                anchor:"100%",
                labelWidth:60,
                margin:"0 0 10 0",
                vertical:true,
                columns:1,
                items: [
                { boxLabel: Rubedo.RubedoAutomatedElementsLoc.telephoneText, checked:component.responsive.phone, handler:function(){component.responsive.phone=this.getValue();} },
                { boxLabel: Rubedo.RubedoAutomatedElementsLoc.tabletText, checked:component.responsive.tablet, handler:function(){component.responsive.tablet=this.getValue();}},
                { boxLabel: Rubedo.RubedoAutomatedElementsLoc.computerText, checked:component.responsive.desktop, handler:function(){component.responsive.desktop=this.getValue();}}
                ]

            }));  







            configSpec.getComponent(1).add(Ext.widget('textfield',{
                itemId:"eClassHTMLField",
                fieldLabel:Rubedo.RubedoAutomatedElementsLoc.HTMLClassText,
                onChange:function(){
                    if (this.isValid()){
                        component.classHTML=this.getValue();
                    }
                },
                labelWidth:60,
                allowBlank:true,
                anchor:"100%",
                margin:"10 0 0 0",
                value:component.classHTML
            }));

            configSpec.getComponent(1).add(Ext.widget('textfield',{
                itemId:"eidHTMLField",
                fieldLabel:Rubedo.RubedoAutomatedElementsLoc.HTMLIdText,
                onChange:function(){
                    if (this.isValid()){
                        component.idHTML=this.getValue();
                    }
                },
                labelWidth:60,
                allowBlank:true,
                anchor:"100%",
                margin:"10 0 0 0",
                value:component.idHTML
            }));
            configSpec.getComponent(1).add(Ext.widget('textfield',{
                itemId:"eStyleField",
                fieldLabel:Rubedo.RubedoAutomatedElementsLoc.styleText,
                onChange:function(){
                    if (this.isValid()){
                        component.elementStyle=this.getValue();
                    }
                },
                labelWidth:60,
                allowBlank:true,
                anchor:"100%",
                margin:"10 0 0 0",
                value:component.elementStyle
            }));
            configSpec.getComponent(1).add(Ext.widget('combobox',{
                itemId:"eTagField",
                fieldLabel:Rubedo.RubedoAutomatedElementsLoc.tagText,
                queryMode:"local",
                store:["div","span","header","section","footer","aside"],
                onChange:function(){
                    if (this.isValid()){
                        component.elementTag=this.getValue();
                    }
                },
                labelWidth:60,
                allowBlank:true,
                anchor:"100%",
                margin:"10 0 0 0",
                value:component.elementTag
            }));
            if (component.mType=="row"){
                Ext.getCmp("moveElementUp").enable();
                Ext.getCmp("moveElementDown").enable();
                Ext.getCmp('newRow').disable();
                Ext.getCmp("newBloc").disable();
                if (component.getComponent("eol").flex===0){
                    Ext.getCmp('newCol').disable();
                } else {
                    Ext.getCmp('newCol').enable();
                }
                configSpec.getComponent(0).insert(2,Ext.widget('checkbox',{
                    itemId:"eTabField",
                    fieldLabel:Rubedo.RubedoAutomatedElementsLoc.displayAsTabsText,
                    onChange:function(){

                        component.displayAsTab=this.getValue();

                    },
                    labelWidth:60,
                    inputValue:true,
                    anchor:"100%",
                    margin:"10 0 10 0",
                    checked:component.displayAsTab
                }));
                configSpec.getComponent(1).add(Ext.widget('checkbox',{
                    itemId:"eDisplayRowField",
                    fieldLabel:Rubedo.RubedoAutomatedElementsLoc.displayRowTagText,
                    onChange:function(){

                        component.displayRow=this.getValue();

                    },
                    labelWidth:60,
                    inputValue:true,
                    anchor:"100%",
                    margin:"10 0 10 0",
                    checked:component.displayRow
                }));
                configSpec.getComponent(1).add(Ext.widget('checkbox',{
                    itemId:"eDisplayRowFluidField",
                    fieldLabel:Rubedo.RubedoAutomatedElementsLoc.displayRowFluidTagText,
                    onChange:function(){

                        component.displayRowFluid=this.getValue();

                    },
                    labelWidth:60,
                    inputValue:true,
                    anchor:"100%",
                    margin:"10 0 10 0",
                    checked:component.displayRowFluid
                }));
                configSpec.getComponent(1).add(Ext.widget('checkbox',{
                    itemId:"eIncludeContainerField",
                    fieldLabel:Rubedo.RubedoAutomatedElementsLoc.includeInAContainerText,
                    onChange:function(){

                        component.includeContainer=this.getValue();

                    },
                    labelWidth:60,
                    inputValue:true,
                    anchor:"100%",
                    margin:"10 0 10 0",
                    checked:component.includeContainer
                }));
                configSpec.getComponent(1).add(Ext.widget('checkbox',{
                    itemId:"eIncludeContainerFluidField",
                    fieldLabel:Rubedo.RubedoAutomatedElementsLoc.includeInAContainerFluidText,
                    onChange:function(){

                        component.includeContainerFluid=this.getValue();

                    },
                    labelWidth:60,
                    inputValue:true,
                    anchor:"100%",
                    margin:"10 0 10 0",
                    checked:component.includeContainerFluid
                }));
                configSpec.getComponent(1).add(Ext.widget('textfield',{
                    itemId:"eContainerIdHTMLField",
                    fieldLabel:Rubedo.RubedoAutomatedElementsLoc.containerIdText,
                    onChange:function(){
                        if (this.isValid()){
                            component.containerId=this.getValue();
                        }
                    },
                    labelWidth:60,
                    allowBlank:true,
                    anchor:"100%",
                    margin:"10 0 0 0",
                    value:component.containerId
                }));
                configSpec.getComponent(1).add(Ext.widget('textfield',{
                    itemId:"eConainerStyleField",
                    fieldLabel:Rubedo.RubedoAutomatedElementsLoc.containerClassText,
                    onChange:function(){
                        if (this.isValid()){
                            component.containerClass=this.getValue();
                        }
                    },
                    labelWidth:60,
                    allowBlank:true,
                    anchor:"100%",
                    margin:"10 0 0 0",
                    value:component.containerClass
                }));
                /*configSpec.getComponent(0).add(Ext.widget('button',{
                itemId:"rowAutoHeight",
                text:"Hauteur automatique",
                anchor:"100%",
                tooltip:"La hauteur s'adapte au contenu lors du rendu final",
                hidden:true,
                handler:function(){
                abstractcomponent.setHeight(null);
                abstractcomponent.flex=1;
                abstractcomponent.up().doLayout();
                configSpec.getComponent(0).getComponent("rowHeightFixed").setValue();
                this.hide();
                }
                }));
                if (!Ext.isEmpty(abstractcomponent.height)){configSpec.getComponent(0).getComponent("rowAutoHeight").show();}
                configSpec.getComponent(0).add(Ext.widget('numberfield',{
                itemId:"rowHeightFixed",
                fieldLabel:"Hauteur fixe ",
                labelWidth:60,
                allowDecimals:false,
                allowBlank:false,
                minValue:20,
                anchor:"60%",
                margin:"10 0 0 0",
                style:"{float:left;}",
                value:abstractcomponent.height
                }));
                configSpec.getComponent(0).add(Ext.widget('button',{
                text:"Appliquer",
                anchor:"38%",
                margin:"10 0 0 0",
                style:"{float:right;}",
                handler:function(){
                if (configSpec.getComponent(0).getComponent("rowHeightFixed").isValid()){
                abstractcomponent.flex=null;
                abstractcomponent.setHeight(configSpec.getComponent(0).getComponent("rowHeightFixed").getValue());
                abstractcomponent.up().doLayout();
                configSpec.getComponent(0).getComponent("rowAutoHeight").show();
                }}
                }));
                */


            }    

            else if (component.mType=="col"){
                Ext.getCmp("moveElementUp").disable();
                Ext.getCmp("moveElementDown").disable();
                if ((component.final)){
                Ext.getCmp('newRow').disable();} else if ((Ext.isDefined(component.items.items[0]))&&(component.items.items[0].isXType("unBloc"))) {
                    Ext.getCmp('newRow').disable();
                }else {
                    Ext.getCmp('newRow').enable();
                }

                Ext.getCmp('newCol').disable();
                if ((Ext.isEmpty(component.items.items))||(component.items.items[0].isXType("unBloc"))){
                Ext.getCmp("newBloc").enable();} else {Ext.getCmp("newBloc").disable();}

                    configSpec.getComponent(0).insert(2,Ext.widget('checkbox',{
                        itemId:"eMainColField",
                        fieldLabel:Rubedo.RubedoAutomatedElementsLoc.mainColumnText,
                        onChange:function(){
                            if (this.getValue()){
                                Ext.getCmp("mainColumnIdField").setValue(component.getId());
                            } else {
                                Ext.getCmp("mainColumnIdField").setValue(null);
                            }


                        },
                        labelWidth:60,
                        RTip:Rubedo.RubedoAutomatedElementsLoc.mainColumnRTip,
                        inputValue:true,
                        anchor:"100%",
                        margin:"10 0 10 0",
                        checked:(component.getId()==Ext.getCmp("mainColumnIdField").getValue())
                    }));
                    configSpec.getComponent(1).add(Ext.widget('checkbox',{
                        itemId:"eRenderSpanField",
                        fieldLabel:Rubedo.RubedoAutomatedElementsLoc.showSpanAndOfssetText,
                        onChange:function(){

                            component.renderSpan=this.getValue();

                        },
                        labelWidth:60,
                        inputValue:true,
                        anchor:"100%",
                        margin:"10 0 10 0",
                        checked:component.renderSpan
                    }));

                    var offsetEdit=Ext.widget('numberfield',{
                        itemId:"offsetEditor",
                        fieldLabel:Rubedo.RubedoAutomatedElementsLoc.offsetText,
                        editable:false,
                        labelWidth:60,
                        allowDecimals:false,
                        anchor:"50%",
                        margin:"10 0 0 0",
                        style:"{float:left;}",
                        value:0,
                        minValue:0
                    });

                    var spanEdit=Ext.widget('numberfield',{
                        itemId:"spanEditor",
                        fieldLabel:Rubedo.RubedoAutomatedElementsLoc.spanText,
                        labelWidth:60,
                        editable:false,
                        allowDecimals:false,
                        anchor:"50%",
                        margin:"10 0 0 10",
                        style:"{float:right;}",
                        value:component.flex,
                        minValue:1
                    });



                    configSpec.getComponent(0).add(offsetEdit);
                    configSpec.getComponent(0).add(spanEdit);
                    me.applyConstrain(component,offsetEdit,spanEdit,false);
                    offsetEdit.on("change",function(){me.applyConstrain(component,offsetEdit,spanEdit,true);});
                    spanEdit.on("change",function(){me.applyConstrain(component,offsetEdit,spanEdit,true);});





                }
                propEdit.add(configSpec);
                if ((!ACL.interfaceRights['write.ui.masks'])||(Ext.getCmp("masquesGrid").getSelectionModel().getLastSelected().get("readOnly"))){
                    Ext.Array.forEach(Ext.getCmp("elementEditControl").query("field"), function(truc){truc.setReadOnly(true);});
                    Ext.Array.forEach(Ext.getCmp("elementEditControl").query("button"), function(truc){if (!truc.isXType("tab")){truc.disable();}});
                }
                e.stopEvent();
            });}
    },

    deleteMaskElement: function(button, e, eOpts) {
        var cible=Ext.getCmp(Ext.getCmp('elementIdField').getValue());
        if (cible.mType=="col"){
            var myEol=cible.up().getComponent("eol");
            var myOffset=cible.previousSibling();
            if (!Ext.isEmpty(myOffset)) {
                if ((myOffset.isXType("container"))&&(!(myOffset.isXType("panel")))) {
                    myEol.flex=myEol.flex+myOffset.flex;
                    myOffset.up().remove(myOffset);
                }
            }
            myEol.flex=myEol.flex+cible.flex;

        }
        cible.up().remove(cible);
        Ext.getCmp("newRow").disable();
        Ext.getCmp("newCol").disable();
        Ext.getCmp("newBloc").disable();
        Ext.getCmp("importElement").disable();
        Ext.getCmp("exportElement").disable();
        Ext.getCmp("deleteElement").disable();
        Ext.getCmp("moveElementUp").disable();
        Ext.getCmp("moveElementDown").disable();
        Ext.getCmp('elementEditControl').setTitle(Rubedo.RubedoAutomatedElementsLoc.selectAnElementText);
        Ext.getCmp('elementEditControl').removeAll();
        Ext.getCmp('elementEditControl').setIconCls();
        Ext.getCmp('elementIdField').setValue(null);

    },

    addCol: function(button, e, eOpts) {
        Ext.Ajax.request({
            url: 'xhr-get-mongo-id',
            params: { },
            success: function(response){
                var servedId = Ext.JSON.decode(response.responseText).mongoID;

                var cible=Ext.getCmp(Ext.getCmp('elementIdField').getValue());
                var myEol=cible.getComponent('eol');

                if (myEol.flex>0) {
                    var isFinalCol=false;
                    if (cible.up().mType=="col"){
                        isFinalCol=true;
                    }
                    var newCol=Ext.widget('panel', {
                        header:false,
                        flex:1,
                        renderSpan:true,
                        elementTag:"div",
                        elementStyle:"",
                        final:isFinalCol,
                        id:servedId,
                        eTitle:"titre",
                        responsive:{
                            phone:true,
                            tablet:true,
                            desktop:true
                        },
                        mType:'col',
                        margin:4,
                        layout: {
                            type: 'vbox',
                            align: 'stretch'
                        }
                    });
                    myEol.flex=myEol.flex-1;
                    cible.insert(cible.items.items.length-1,newCol);
                    if (myEol.flex===0){
                        button.disable();
                    }

                }
                newCol.getEl().dom.click();


            },
            failure: function(){
                Ext.Msg.alert(Rubedo.RubedoAutomatedElementsLoc.errorTitle, Rubedo.RubedoAutomatedElementsLoc.columnIdRecoveryError);

            }
        });



    },

    addRow: function(button, e, eOpts) {
        var cible=Ext.getCmp(Ext.getCmp('elementIdField').getValue());
        var row = Ext.widget('panel', {
            header:false,
            mType:"row",
            flex:1,
            elementTag:"div",
            elementStyle:"",
            displayRow:true,
            displayRowFluid:false,
            includeContainer:false,
            includeContainerFluid:false,
            eTitle:"titre",
            responsive:{
                phone:true,
                tablet:true,
                desktop:true
            },
            margin:4,
            layout: {
                type: 'hbox',
                align: 'stretch'
            }
        });
        row.add(Ext.widget('container', {flex:12,itemId:"eol"}));
        cible.insert(cible.items.items.length,row);
        Ext.getCmp("newBloc").disable();
        row.getEl().dom.click();
    },

    showBlocWindow: function(button, e, eOpts) {
        var blocWin = Ext.widget('ajoutBlocFenetre');
        blocWin.showAt(screen.width/2-250, 100);
    },

    importElement: function(button, e, eOpts) {
        var target=button.up().up().up().insTar;
        var child=Ext.clone(Ext.getCmp("ReusableElementsGrid").getSelectionModel().getLastSelected().get("mCode"));
        var cBlocks=Ext.clone(Ext.getCmp("ReusableElementsGrid").getSelectionModel().getLastSelected().get("mBlocks"));
        Ext.Array.forEach(cBlocks,function(someBlock){
            someBlock.id=undefined;
        });
        if (!Ext.isEmpty(child)){
            this.removeIds(child,cBlocks);
        }
        var maskRows = this.saveRows(this.getMasqueEdition());
        var maskBlocks= this.saveBlocks(this.getMasqueEdition());
        if (!Ext.isEmpty(child)){
            if (target.id=="masqueEdition") {
                maskRows.push(child);
            } else {
                this.spliceMask(maskRows,target.id,child,true);
            }
        } else if (!Ext.isEmpty(cBlocks)){
            Ext.Array.forEach(cBlocks,function(someBlock){
                someBlock.parentCol=target.id;
            });
        }
        this.getMasqueEdition().removeAll();
        this.masqueRestit(maskRows,1,this.getMasqueEdition()); 
        var newBlocks=Ext.Array.merge(maskBlocks, cBlocks);
        this.restoreBlocks(newBlocks);
        button.up().up().up().close();
    },

    addBloc: function(button, e, eOpts) {
        var donnees = Ext.getCmp('BlocsSelectGrid').getSelectionModel().getLastSelected().data;
        var nouvBloc = Ext.widget('unBloc', Ext.clone(donnees.configBasique));
        nouvBloc.responsive={
            "phone":true,
            "tablet":true,
            "desktop":true
        };
        nouvBloc.elementStyle="";
        nouvBloc.elementTag="div";
        nouvBloc.renderDiv=true;
        nouvBloc.flex=1;

        var target = Ext.getCmp(Ext.getCmp('elementIdField').getValue());
        var orderValue = 100;
        if (!Ext.isEmpty(target.items.items)) {
            orderValue=target.items.items[target.items.items.length-1].orderValue+100;
        }
        nouvBloc.orderValue=orderValue;
        target.add(nouvBloc);
        button.up().up().close();
        Ext.getCmp('newRow').disable();
        nouvBloc.getEl().dom.click();
    },

    mainBoxSelect: function(component, eOpts) {
        component.setBorder(2);
        component.addBodyCls('contrastCBorder');
        component.getEl().on("mouseover", function(e){
            component.setBorder(4);
            e.stopEvent();
        });
        component.getEl().on("mouseout", function(e){
            component.setBorder(2);
            e.stopEvent();
        });
        component.getEl().on("click", function(e){
            var prevSelected = Ext.getCmp(Ext.getCmp('elementIdField').getValue());
            if (!Ext.isEmpty(prevSelected)) {
                if (prevSelected.isXType("unBloc")) {prevSelected.setIconCls();} else {
            prevSelected.removeBodyCls('selectedelement');}
        }
        component.addBodyCls('selectedelement');
        this.frame(MyPrefData.themeColor);
        Ext.getCmp('elementIdField').setValue(component.id);
        Ext.getCmp('deleteElement').disable();
        Ext.getCmp('newCol').disable();
        Ext.getCmp('newBloc').disable();
        Ext.getCmp('newRow').enable();
        Ext.getCmp("moveElementUp").disable();
        Ext.getCmp("moveElementDown").disable();
        Ext.getCmp("importElement").enable();
        Ext.getCmp("exportElement").disable();
        var propEdit=Ext.getCmp('elementEditControl');
        propEdit.setTitle("Racine");
        propEdit.setIconCls('editZone');
        propEdit.removeAll();
        var configSpec = Ext.widget('ConfigSpecBloc');
        configSpec.getComponent(1).add(Ext.widget('checkbox',{
            fieldLabel:"Afficher dans une div ",
            onChange:function(){

                component.pageProperties.showInDiv=this.getValue();

            },
            labelWidth:60,
            inputValue:true,
            anchor:"100%",
            margin:"10 0 10 0",
            checked:component.pageProperties.showInDiv
        }));
        configSpec.getComponent(1).add(Ext.widget('textfield',{
            fieldLabel:"Id de la div ",
            onChange:function(){
                if (this.isValid()){
                    component.pageProperties.divId=this.getValue();
                }
            },
            labelWidth:60,
            allowBlank:true,
            anchor:"100%",
            margin:"10 0 0 0",
            value:component.pageProperties.divId
        }));
        configSpec.getComponent(1).add(Ext.widget('textfield',{
            fieldLabel:"Classe de la div ",
            onChange:function(){
                if (this.isValid()){
                    component.pageProperties.divClass=this.getValue();
                }
            },
            labelWidth:60,
            allowBlank:true,
            anchor:"100%",
            margin:"10 0 0 0",
            value:component.pageProperties.divClass
        }));
        propEdit.add(configSpec);




    });
    },

    blocSelect: function(component, eOpts) {


        component.getEl().on("mouseover", function(e){
            var prevSelected = Ext.getCmp(Ext.getCmp('elementIdField').getValue());
            if ((Ext.isEmpty(prevSelected))||(prevSelected.id!==component.id)) {
                component.setIconCls('selectBloc');
            }
            e.stopEvent();
        });
        component.getEl().on("mouseout", function(e){
            var prevSelected = Ext.getCmp(Ext.getCmp('elementIdField').getValue());
            if ((Ext.isEmpty(prevSelected))||(prevSelected.id!==component.id)) {
            component.setIconCls();}
            e.stopEvent();
        });
        component.getEl().on("click", function(e){
            var prevSelected = Ext.getCmp(Ext.getCmp('elementIdField').getValue());
            if (!Ext.isEmpty(prevSelected)) {
                if (prevSelected.isXType("unBloc")) {prevSelected.setIconCls();} else {
            prevSelected.removeBodyCls('selectedelement');}
        }
        component.setIconCls('editBloc');
        this.frame(MyPrefData.themeColor);
        Ext.getCmp('elementIdField').setValue(component.id);
        Ext.getCmp('deleteElement').enable();
        Ext.getCmp('newCol').disable();
        Ext.getCmp('newBloc').disable();
        Ext.getCmp('newRow').disable();
        Ext.getCmp("importElement").disable();
        Ext.getCmp("exportElement").enable();
        Ext.getCmp("moveElementUp").enable();
        Ext.getCmp("moveElementDown").enable();
        var propEdit=Ext.getCmp('elementEditControl');
        try{
            propEdit.setTitle("Bloc "+Ext.getStore("BlocsDataStore").findRecord('bType', component.bType).get("type"));
        }catch(err){
            propEdit.setTitle(component.id.replace("unBloc", "Bloc"));
        }
        propEdit.setIconCls('editBloc');
        propEdit.removeAll();


        var configSpec = Ext.widget('ConfigSpecBloc');


        configSpec.getComponent(0).add(Ext.widget('textfield',{
            itemId:"eTitleField",
            fieldLabel:"Titre ",
            onChange:function(){
                if (this.isValid()){
                    component.setTitle(this.getValue());
                }
            },
            labelWidth:60,
            allowBlank:false,
            anchor:"100%",
            margin:"10 0 10 0",
            value:component.title
        }));

        configSpec.getComponent(0).add(Ext.widget('checkbox',{
            itemId:"eTitleShowField",
            fieldLabel:"Afficher le titre ",
            onChange:function(){

                component.displayTitle=this.getValue();

            },
            labelWidth:60,
            inputValue:true,
            anchor:"100%",
            margin:"10 0 10 0",
            checked:component.displayTitle
        }));


        /*configSpec.getComponent(0).add(Ext.widget('numberfield',{
        fieldLabel:"Hauteur fluide ",
        onChange:function(){
        if(this.isValid()) {
        abstractcomponent.flex=this.getValue();
        abstractcomponent.up().doLayout();
        }
        },
        labelWidth:60,
        allowDecimals:false,
        allowBlank:false,
        minValue:1,
        anchor:"100%",
        margin:"10 0 0 0",
        value:abstractcomponent.flex
        }));*/



        configSpec.getComponent(0).add(Ext.widget('checkboxgroup',{
            fieldLabel:"Visibilité ",
            anchor:"100%",
            labelWidth:60,
            margin:"0 0 10 0",
            vertical:true,
            columns:1,
            items: [
            { boxLabel: 'Téléphone', checked:component.responsive.phone, handler:function(){component.responsive.phone=this.getValue();} },
            { boxLabel: 'Tablette',checked:component.responsive.tablet, handler:function(){component.responsive.tablet=this.getValue();}},
            { boxLabel: 'Ordinateur',checked:component.responsive.desktop, handler:function(){component.responsive.desktop=this.getValue();}}
            ]

        }));  






        configSpec.getComponent(1).add(Ext.widget('textfield',{
            itemId:"eClassHTMLField",
            fieldLabel:"Classe HTML ",
            onChange:function(){
                if (this.isValid()){
                    component.classHTML=this.getValue();
                }
            },
            labelWidth:60,
            allowBlank:true,
            anchor:"100%",
            margin:"10 0 0 0",
            value:component.classHTML
        }));

        configSpec.getComponent(1).add(Ext.widget('textfield',{
            itemId:"eidHTMLField",
            fieldLabel:"Id HTML ",
            onChange:function(){
                if (this.isValid()){
                    component.idHTML=this.getValue();
                }
            },
            labelWidth:60,
            allowBlank:true,
            anchor:"100%",
            margin:"10 0 0 0",
            value:component.idHTML
        }));

        configSpec.getComponent(1).add(Ext.widget('textfield',{
            itemId:"urlPrefixHTMLField",
            fieldLabel:"Préfixe URL ",
            onChange:function(){
                if (this.isValid()){
                    component.urlPrefix=this.getValue();
                }
            },
            labelWidth:60,
            regex :new RegExp(/^([a-z]|[1-9]|[-]){0,}$/),
            allowBlank:true,
            anchor:"100%",
            margin:"10 0 0 0",
            value:component.urlPrefix
        }));
        configSpec.getComponent(1).add(Ext.widget('textfield',{
            itemId:"eStyleField",
            fieldLabel:"Style ",
            onChange:function(){
                if (this.isValid()){
                    component.elementStyle=this.getValue();
                }
            },
            labelWidth:60,
            allowBlank:true,
            anchor:"100%",
            margin:"10 0 0 0",
            value:component.elementStyle
        }));
        configSpec.getComponent(1).add(Ext.widget('combobox',{
            itemId:"eTagField",
            fieldLabel:"Tag ",
            queryMode:"local",
            store:["div","span","header","section","footer","aside"],
            onChange:function(){
                if (this.isValid()){
                    component.elementTag=this.getValue();
                }
            },
            labelWidth:60,
            allowBlank:true,
            anchor:"100%",
            margin:"10 0 0 0",
            value:component.elementTag
        }));
        configSpec.getComponent(1).add(Ext.widget('checkbox',{
            itemId:"eRenderDivField",
            fieldLabel:"Afficher dans une div ",
            onChange:function(){

                component.renderDiv=this.getValue();

            },
            labelWidth:60,
            inputValue:true,
            anchor:"100%",
            margin:"10 0 10 0",
            checked:component.renderDiv
        }));

        var categories = Ext.clone(component.champsConfig.simple);
        var categoriesADV = Ext.clone(component.champsConfig.avance);

        Ext.Array.forEach(categoriesADV,function(someCat){someCat.isAdv=true;});
        categories=Ext.Array.merge(categories,categoriesADV);
        for (j=0; j<categories.length; j++){
            var nCateg = Ext.create('Ext.form.FieldSet', {title: categories[j].categorie, collapsible:true, layout: 'anchor'});

            var champsS = Ext.clone(categories[j].champs);
            for (i=0; i<champsS.length; i++) {
                if (champsS[i].type =='Ext.ux.TreePicker') {
                    var filteredStore=  Ext.create("Ext.data.TreeStore",{autoLoad: false,
                            autoSync: false,
                            isOptimised:true,
                            usedCollection:"Pages",
                            model: 'Rubedo.model.pageDataModel',
                            proxy: {
                                type: 'ajax',
                                api: {
                                    create: 'pages/create',
                                    read: 'pages/tree',
                                    update: 'pages/update',
                                    destroy: 'pages/delete'
                                },
                                reader: {
                                    type: 'json',
                                    getResponseData: function(response) {
                                        var data, error;

                                    try {
                                        data = Ext.decode(response.responseText);
                                        if (Ext.isDefined(data.data)){data.children=data.data;}// error fix
                                        return this.readRecords(data);
                                    } catch (ex) {
                                        error = new Ext.data.ResultSet({
                                            total  : 0,
                                            count  : 0,
                                            records: [],
                                            success: false,
                                            message: ex.message
                                        });

                                        this.fireEvent('exception', this, response, error);
                                        console.log(ex);

                                        Ext.Logger.warn('Unable to parse the JSON returned by the server');

                                        return error;
                                    }
                                },
                                messageProperty: 'message'
                            }
                        },
                        sorters: {
                            property: 'orderValue'
                        }
                    }); 

                    filteredStore.getProxy().extraParams.filter="[{\"property\":\"site\",\"value\":\""+Ext.getCmp("masquesGrid").getSelectionModel().getLastSelected().get("site")+"\"}]";
                    filteredStore.load();
                    champsS[i].config.store= filteredStore;
                    champsS[i].config.displayField="text";
                    champsS[i].config.plugins=[Ext.create("Ext.ux.form.field.ClearButton")];



                }else if (champsS[i].isAutoStored){
                    var miniStore=Ext.create('Ext.data.Store', {
                        fields:[{name:"value"},{name:"label"}],
                        data:champsS[i].autoStoreData,
                        autoload:true
                    });
                    champsS[i].config.store= miniStore;
                    champsS[i].config.displayField="label";
                    champsS[i].config.valueField="value";
                } 
                var nChampS = Ext.create(champsS[i].type, champsS[i].config);
                if (champsS[i].type =='Ext.form.field.Trigger'){
                    var Ouvrir = Ext.clone(champsS[i].ouvrir);
                    var targeting=Ext.clone(nChampS.id);
                    nChampS.onTriggerClick= function() {
                        var fenetre = Ext.widget(Ouvrir);
                        fenetre.show();
                        fenetre.mainFieldId=targeting;

                    } ;  
                }
                nChampS.labelSeparator= ' ';
                nChampS.anchor= '100%';
                nChampS.labelWidth=60;
                nChampS.setValue(component.configBloc[nChampS.name]);
                if ((nChampS.isXType("combobox"))&&(!nChampS.isXType("treepicker"))){
                    nChampS.getStore().fieldId=Ext.clone(nChampS.id);
                    nChampS.getStore().fieldValue=Ext.clone(component.configBloc[nChampS.name]);
                    nChampS.getStore().addListener("load",function(storeThing){
                        Ext.getCmp(storeThing.fieldId).setValue(storeThing.fieldValue);
                    },this,{single:true});
                    }
                    if (nChampS.isXType("treepicker")){
                        nChampS.on('select', function(){component.configBloc[this.name]=this.getValue(); });

                    }
                    if (nChampS.isXType("comboboxselect")){
                        nChampS.on('afterrender', function(thing){thing.fireEvent("change");});

                    }
                    nChampS.on('change', function(){component.configBloc[this.name]=this.getValue();});
                    nCateg.add(nChampS);
                }
                if(nCateg.isAdv){
                    configSpec.getComponent(1).add(nCateg);
                }else{
                    configSpec.getComponent(0).add(nCateg);
                }


            }
            propEdit.add(configSpec);


            if ((!ACL.interfaceRights['write.ui.masks'])||(Ext.getCmp("masquesGrid").getSelectionModel().getLastSelected().get("readOnly"))){
                Ext.Array.forEach(Ext.getCmp("elementEditControl").query("field"), function(truc){truc.setReadOnly(true);});
                Ext.Array.forEach(Ext.getCmp("elementEditControl").query("button"), function(truc){if (!truc.isXType("tab")){truc.disable();}});
            }
            e.stopEvent();

        });
    },

    exportElement: function(button, e, eOpts) {
        var form = button.up().getForm();
        if (form.isValid()) {
            var values=form.getValues();
            var target=Ext.getCmp(Ext.getCmp('elementIdField').getValue());
            var maskRows = this.saveRows(this.getMasqueEdition());
            var mCode=this.findElement(maskRows,target.id);
            var mBlocks=this.saveBlocks(target);
            var newElement=Ext.create("Rubedo.model.reusableElementModel",{
                name:values.name,
                description:values.description,
                mCode:mCode,
                mBlocks:mBlocks,
                depth:this.getElementDepth(mCode),
                mType:target.mType,
                mLevel:this.getElementLevel(target,0),
                site:Ext.getCmp("masquesGrid").getSelectionModel().getLastSelected().get("site")
            });
            Ext.getStore("ReusableElementsDataStore").add(newElement);
        }
        button.up().up().close();

    },

    addBlocDblClick: function(dataview, record, item, index, e, eOpts) {
        if (Ext.getCmp("BlocsSelectGrid").pageMode){
            Ext.getCmp("addPageBlocBtn").fireEvent("click");
        } else {
            this.addBloc(Ext.getCmp("boutonAjouterBloc"));
        }
    },

    exportMaskElementWindow: function(button, e, eOpts) {
        var fenetre = Ext.widget('ExportElementWindow');
        Ext.getCmp('ViewportPrimaire').add(fenetre);
        fenetre.show();
    },

    showImportWindow: function(button, e, eOpts) {
        var fenetre = Ext.widget('ReusableElementPicker');
        Ext.getCmp('ViewportPrimaire').add(fenetre);
        var target=Ext.getCmp(Ext.getCmp('elementIdField').getValue());
        var maskRows = this.saveRows(this.getMasqueEdition());
        var mCode=this.findElement(maskRows,target.id);
        var site=Ext.getCmp("masquesGrid").getSelectionModel().getLastSelected().get("site");
        var level=this.getElementLevel(target,0);
        Ext.getStore("ReusableElementsDataStore").clearFilter();
        Ext.getStore("ReusableElementsDataStore").filter("site",site);
        fenetre.insTar={mType:target.mType,level:level,id:target.id,mCode:mCode};
        fenetre.show();

    },

    moveElementUp: function(button, e, eOpts) {
        var target=Ext.getCmp(Ext.getCmp('elementIdField').getValue());
        if (!Ext.isEmpty(target)) {
            var pos = target.up().items.indexOf(target);
            if (pos > 0) {
                target.up().move(pos,pos-1);
                if (target.isXType('unBloc')){
                    Ext.Array.forEach(target.up().items.items, function(item, index){
                        if (index===0){item.orderValue=100;} else {item.orderValue=(index+1)*100;}
                    });
                }
            }
        }
    },

    moveElementDown: function(button, e, eOpts) {
        var target=Ext.getCmp(Ext.getCmp('elementIdField').getValue());
        if (!Ext.isEmpty(target)) {
            var pos = target.up().items.indexOf(target);
            target.up().move(pos,pos+1);
            if (target.isXType('unBloc')){
                Ext.Array.forEach(target.up().items.items, function(item, index){
                    if (index===0){item.orderValue=100;} else {item.orderValue=(index+1)*100;}
                });
            }
        }
    },

    blocDetailShow: function(rowmodel, record, index, eOpts) {
        Ext.getCmp("PaneauBlocsDetail").update(record.getData());
    },

    onMainColumnIdFieldChange: function(field, newValue, oldValue, eOpts) {
        if (!Ext.isEmpty(Ext.getCmp(newValue))){
            Ext.getCmp(newValue).addBodyCls("mainColumn");
        }
        if (!Ext.isEmpty(Ext.getCmp(oldValue))){
            Ext.getCmp(oldValue).removeBodyCls("mainColumn");
        }
    },

    removeIds: function(element, blocks) {
        var me=this;
        if (element.mType=="col"){
            var newId=Ext.id(null,"column-");
            Ext.Array.forEach(blocks,function(someBlock){
                if (someBlock.parentCol==element.id){
                    someBlock.parentCol=newId;
                }
            });
            element.id=newId;
        } else {
            element.id=undefined;
        }
        if (!Ext.isEmpty(element.columns)) {
            Ext.Array.forEach(element.columns,function(thing){me.removeIds(thing,blocks);});
        }
        if (!Ext.isEmpty(element.rows)) {
            Ext.Array.forEach(element.rows,function(thing){me.removeIds(thing,blocks);});
        }
        if (!Ext.isEmpty(element.blocks)) {
            Ext.Array.forEach(element.blocks,function(thing){me.removeIds(thing,blocks);});
        }
    },

    applyConstrain: function(target, offsetF, spanF, applyFirst) {
        var myEol=target.up().getComponent("eol");
        var myOffset=null;
        if ((!Ext.isEmpty(target.prev()))&&(target.prev().isXType("container"))&&(!(target.prev().isXType("panel")))) {
            myOffset=target.prev();
        }
        if (applyFirst) {
            myEol.flex=myEol.flex+target.flex-spanF.getValue();
            target.flex=spanF.getValue();
            spanF.setMaxValue(target.flex+myEol.flex);
            offsetF.setMaxValue(offsetF.getValue()+myEol.flex);
            target.up().doLayout();
            if (offsetF.getValue()>0){ 
                if (Ext.isEmpty(myOffset)) {
                    myOffset=Ext.widget("container",{flex:0,style:"{background-image:url(resources/images/stripes.png);}"});
                    target.up().insert(Ext.Array.indexOf(target.up().items.items,target),myOffset);


                } 
                myEol.flex=myEol.flex+myOffset.flex-offsetF.getValue();
                myOffset.flex=offsetF.getValue();
                offsetF.setMaxValue(myOffset.flex+myEol.flex);
                spanF.setMaxValue(spanF.getValue()+myEol.flex);
                target.up().doLayout();

            } else if((offsetF.getValue()===0)) {
                if (!Ext.isEmpty(myOffset)) {
                    myEol.flex=myEol.flex+myOffset.flex-offsetF.getValue();
                    myOffset.flex=offsetF.getValue();
                    offsetF.setMaxValue(myOffset.flex+myEol.flex);
                    spanF.setMaxValue(spanF.getValue()+myEol.flex);
                    myOffset.destroy();
                    target.up().doLayout();      
                } 

            }
        }
        else {
            if (Ext.isEmpty(myOffset)){
                offsetF.setValue(0);
                offsetF.setMaxValue(myEol.flex);
            }
            else {
                offsetF.setValue(myOffset.flex);
                offsetF.setMaxValue(myOffset.flex+myEol.flex); 
            }

            spanF.setValue(target.flex);
            spanF.setMaxValue(target.flex+myEol.flex);
        }
    },

    spliceMask: function(elements, id, child, continueOK) {
        var me=this;
        if (continueOK){
            Ext.Array.forEach(elements, function(element){
                if (continueOK){
                    if (element.id==id) {
                        var leprop="rows";
                        if (child.mType=="col") { leprop="columns";
                            if(Ext.isEmpty(element[leprop])){
                                element[leprop]=[ ];
                            }
                        element[leprop].push(child);}
                        if ((element.mType=="col")&&(child.mType=="row")){
                            element.isTerminal=false;
                        }
                        continueOK=false;
                    } else {
                        if (!Ext.isEmpty(element.columns)) {
                            me.spliceMask(element.columns,id,child,continueOK);
                        }
                        if (!Ext.isEmpty(element.rows)) {
                            me.spliceMask(element.rows,id,child,continueOK);
                        }
                    }

                }
            });}
    },

    findElement: function(someArray, elementId) {
        var me=this;
        var result= null;
        Ext.Array.forEach(someArray, function(element){
            if (result===null){
                if (element.id===elementId){
                    result=Ext.clone(element);
                } else {
                    if (!Ext.isEmpty(element.columns)) {
                        result=(me.findElement(element.columns,elementId));
                    }
                    if ((!Ext.isEmpty(element.rows))&&(result===null)) {
                        result=me.findElement(element.rows,elementId);
                    }
                    if ((!Ext.isEmpty(element.blocks))&&(result===null)) {
                        result=me.findElement(element.blocks,elementId);
                    }
                }}

            });
            return (result);
    },

    masqueMAJ: function(cible) {
        var nouvZones = [ ];
        var zonesM =Ext.getCmp('masqueEdition').items.items;
        for (i=0; i<zonesM.length; i++) {
            var nZone = {hauteur: zonesM[i].height, largeur: zonesM[i].width, nom: zonesM[i].title, colonnes: [ ] };
            var colonnesM = zonesM[i].items.items;
            for (j=0; j<colonnesM.length; j++){
                var nColonne = {flex:colonnesM[j].flex, blocs: [ ]};
                var blocsM =colonnesM[j].items.items;
                for(k=0;k<blocsM.length; k++) {
                    nColonne.blocks.push({ flex : blocsM[k].flex, title: blocsM[k].title, bType: blocsM[k].bType, champsConfig: blocsM[k].champsConfig, configBloc: blocsM[k].configBloc});
                }        
                nZone.colonnes.push(nColonne);
            }
            nouvZones.push(nZone);
        }
        cible.data.zones=nouvZones;
    },

    getElementDepth: function(element) {
        var me = this;
        if (Ext.isEmpty(element)){
            return(0);
        }
        if (element.mType=="block") {
            return(1);
        }
        else if (element.mType=="col") {
            var bDepth = 1;
            if (!Ext.isEmpty(element.blocks)) {bDepth=2;}
            var cDepth = 1;
            if (!Ext.isEmpty(element.rows)) {
                cDepth= 1+Ext.Array.max(Ext.Array.map(element.rows,function(row){return(me.getElementDepth(row));}));
            }

            return(Math.max(bDepth,cDepth));
        }
        else if (element.mType=="row") {
            if (Ext.isEmpty(element.columns)) {
                return(1);
            }else{
                return( 1+Ext.Array.max(Ext.Array.map(element.columns,function(col){return(me.getElementDepth(col));})));
            }
        } else {
            return(0);
        }
    },

    masqueRestit: function(mRows, its, cible) {
        var me=this;
        Ext.Array.forEach(mRows, function(row){
            var newRow = Ext.widget('panel', {
                header:false,
                mType:"row",
                eTitle:row.eTitle,
                id:row.id,
                elementStyle:row.elementStyle,
                elementTag:row.elementTag,
                displayRow:row.displayRow,
                containerId:row.containerId,
                containerClass:row.containerClass,
                displayRowFluid:row.displayRowFluid,
                includeContainer:row.includeContainer,
                includeContainerFluid:row.includeContainerFluid,
                displayAsTab:row.displayAsTab,
                responsive:row.responsive,
                classHTML:row.classHTML,
                idHTML:row.idHTML,
                displayTitle:row.displayTitle,
                margin:4,
                layout: {
                    type: 'hbox',
                    align: 'stretch'
                }
            });
            var rFlex=1;
            var eolWidth=12;
            Ext.Array.forEach(row.columns, function(column){
                if (column.offset>0) {
                    newRow.add(Ext.widget('container', {
                        flex:column.offset,
                        style:"{background-image:url(resources/images/stripes.png);}"
                    }));
                    eolWidth=eolWidth-column.offset;
                }
                var isFinalCol=false;
                if (its<=0){isFinalCol=true;}
                var newCol=Ext.widget('panel', {
                    header:false,
                    flex:column.span,
                    final:isFinalCol,
                    mType:'col',
                    id:column.id,
                    elementStyle:column.elementStyle,
                    elementTag:column.elementTag,
                    renderSpan:column.renderSpan,
                    eTitle:column.eTitle,
                    responsive:column.responsive,
                    classHTML:column.classHTML,
                    displayTitle:column.displayTitle,
                    idHTML:column.idHTML,
                    margin:4,
                    layout: {
                        type: 'vbox',
                        align: 'stretch'
                    }
                });
                if ((its>0)&&(column.isTerminal===false)) {
                    rFlex=Ext.Array.max([rFlex,column.rows.length]);
                    me.masqueRestit(column.rows,its-1,newCol);    
                }

                eolWidth=eolWidth-column.span;
                newRow.add(newCol);

            });
            newRow.add(Ext.widget("container",{
                flex:eolWidth,
                itemId:"eol"
            }));
            if (Ext.isEmpty(row.height)) {
                newRow.flex=rFlex;
            } else {
                newRow.height=row.height;
            }
            cible.add(newRow);  
        });
    },

    restoreBlocks: function(mBlocks) {
        Ext.Array.forEach(mBlocks, function(block){
            var targetCol=Ext.getCmp(block.parentCol);
            if ((!Ext.isEmpty(targetCol))&&(targetCol.mType=='col')){
                if (Ext.isEmpty(block.configBloc)){
                    block.configBloc={ };
                }
                block.flex=1;
                targetCol.add(Ext.widget("unBloc",block));
            }
        });
    },

    getElementLevel: function(element, level) {
        if (element.id=="masqueEdition") {
            return (level);
        } else {   
            return(this.getElementLevel(element.up(),level+1));
        }
    },

    saveRows: function(startComp) {
        var me=this;
        var nRows=[ ];
        Ext.Array.forEach(startComp.items.items, function(row){
            var newCols = [ ];
            var offset=0;
            Ext.Array.forEach(row.items.items, function(col){
                if (col.isXType("panel")) {
                    var rows = null;
                    var isTerminal=true;
                    if (col.final) { 

                    }else {
                        var thing=col.items.items[0];
                        if (Ext.isEmpty(thing)){} else if (thing.isXType("unBloc")) {

                    } else {
                        isTerminal=false;
                        rows=me.saveRows(col);
                    }
                }

                newCols.push({
                    eTitle:col.eTitle,
                    responsive:col.responsive,
                    classHTML:col.classHTML,
                    idHTML:col.idHTML,
                    elementStyle:col.elementStyle,
                    elementTag:col.elementTag,
                    renderSpan:col.renderSpan,
                    displayTitle:col.displayTitle,
                    span:col.flex,
                    id:col.id,
                    mType:"col",
                    offset:offset,
                    rows: rows,
                    isTerminal:isTerminal

                });
                offset=0;
            } else {offset=offset+col.flex;}

            });
            nRows.push({
                height:row.height,
                eTitle:row.eTitle,
                id:row.id,
                elementStyle:row.elementStyle,
                elementTag:row.elementTag,
                displayRow:row.displayRow,
                displayRowFluid:row.displayRowFluid,
                includeContainer:row.includeContainer,
                includeContainerFluid:row.includeContainerFluid,
                mType:"row",
                displayAsTab:row.displayAsTab,
                responsive:row.responsive,
                displayTitle:row.displayTitle,
                containerId:row.containerId,
                containerClass:row.containerClass,
                classHTML:row.classHTML,
                idHTML:row.idHTML,
                columns: newCols

            });
        });
        return nRows;
    },

    saveBlocks: function(startComp) {
        var newBlocks = [ ];
        var searchArray=startComp.query("unBloc");
        if (startComp.isXType("unBloc")){
            searchArray.push(startComp);
        }
        Ext.Array.forEach(searchArray, function(nBloc){
            newBlocks.push({

                bType:nBloc.bType,
                id:nBloc.id,
                parentCol:nBloc.up().getId(),
                mType:"block",
                champsConfig:nBloc.champsConfig,
                orderValue:nBloc.orderValue,
                configBloc:nBloc.configBloc,
                elementStyle:nBloc.elementStyle,
                elementTag:nBloc.elementTag,
                renderDiv:nBloc.renderDiv,
                title:nBloc.title,
                responsive:nBloc.responsive,
                classHTML:nBloc.classHTML,
                displayTitle:nBloc.displayTitle,
                idHTML:nBloc.idHTML,
                urlPrefix:nBloc.urlPrefix,
                flex:nBloc.flex,
                canEdit:nBloc.canEdit

            });

        });
        return(newBlocks);
    },

    init: function(application) {
        this.control({
            "#boutonSupprimerMasque": {
                click: this.deleteMask
            },
            "#masquesGrid": {
                select: this.masquesDisplay
            },
            "#ReusableElementsGrid": {
                select: this.reusablesGridSelect
            },
            "#arborescenceSites": {
                itemclick: this.onTreepanelItemClick
            },
            "#boutonCopierMasque": {
                click: this.copyMaskWindow
            },
            "#boutonNouveauMasque": {
                click: this.newMaskWindow
            },
            "#creerNouveauMasque": {
                click: this.createMask
            },
            "#AdminfMasquesEnregistrer": {
                click: this.maskSave
            },
            "#copierMasque": {
                click: this.copyMask
            },
            "#AdminfMasquesImporter": {
                click: this.importMaskWindow
            },
            "#masqueEdition panel": {
                render: this.selectionEvents
            },
            "#deleteElement": {
                click: this.deleteMaskElement
            },
            "#newCol": {
                click: this.addCol
            },
            "#newRow": {
                click: this.addRow
            },
            "#newBloc": {
                click: this.showBlocWindow
            },
            "#REAddButton": {
                click: this.importElement
            },
            "#boutonAjouterBloc": {
                click: this.addBloc
            },
            "#masqueEdition": {
                render: this.mainBoxSelect
            },
            "#masqueEdition unBloc": {
                render: this.blocSelect
            },
            "#ExportElementButton": {
                click: this.exportElement
            },
            "#BlocsSelectGrid": {
                itemdblclick: this.addBlocDblClick,
                select: this.blocDetailShow
            },
            "#exportElement": {
                click: this.exportMaskElementWindow
            },
            "#importElement": {
                click: this.showImportWindow
            },
            "#moveElementUp": {
                click: this.moveElementUp
            },
            "#moveElementDown": {
                click: this.moveElementDown
            },
            "#mainColumnIdField": {
                change: this.onMainColumnIdFieldChange
            }
        });
    }

});
